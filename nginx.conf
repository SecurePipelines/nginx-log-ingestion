# =========================================================
# NGINX â€“ Production Log Ingestion Gateway
# Namespace: observability
# =========================================================

user nginx;
worker_processes auto;
worker_rlimit_nofile 200000;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections 10000;
    multi_accept on;
    use epoll;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format main
      '$remote_addr [$time_local] "$request" '
      '$status $body_bytes_sent '
      'rt=$request_time '
      'uct=$upstream_connect_time '
      'urt=$upstream_response_time';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    keepalive_timeout 65;
    keepalive_requests 10000;

    client_max_body_size 100m;
    client_body_buffer_size 1m;
    proxy_buffering off;

    server_tokens off;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:50m;
    ssl_session_timeout 1d;

    limit_req_zone $binary_remote_addr zone=loglimit:20m rate=300r/s;

    upstream vector_gateway {
        least_conn;
        server vector-gateway.observability.svc.cluster.local:8080;
        keepalive 128;
    }

    upstream vector_security {
        least_conn;
        server vector-security.observability.svc.cluster.local:8080;
        keepalive 128;
    }

    upstream vector_metrics {
        least_conn;
        server vector-metrics.observability.svc.cluster.local:8080;
        keepalive 64;
    }

    server {
        listen 443 ssl http2;
        server_name _;

        ssl_certificate     /etc/nginx/tls/tls.crt;
        ssl_certificate_key /etc/nginx/tls/tls.key;

        location /health {
            access_log off;
            return 200 "OK\n";
        }

        location /logs {
            limit_req zone=loglimit burst=1000 nodelay;
            proxy_http_version 1.1;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;

            proxy_pass http://vector_gateway;
        }

        location /security {
            limit_req zone=loglimit burst=500 nodelay;
            proxy_http_version 1.1;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;

            proxy_pass http://vector_security;
        }

        location /metrics {
            access_log off;
            proxy_http_version 1.1;
            proxy_pass http://vector_metrics;
        }

        location / {
            return 404;
        }
    }
}
